{# templates/estimate/yearly/display.html.twig #}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Feed Requirement & Cost - {{ data.year }}</title>
    <style>
        /* (CSS copied exactly from your provided style) */
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f5f7fa; padding: 20px; color: #333; line-height: 1.6; }
        .container { max-width: 1300px; margin: 0 auto; background-color: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); padding: 25px; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 10px; padding-bottom: 15px; border-bottom: 2px solid #eaeaea; }
        .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 30px; font-size: 1.1em; }
        .table-container { overflow-x: auto; margin-bottom: 25px; border-radius: 8px; border: 1px solid #e1e5eb; }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        th { background-color: #2c3e50; color: white; font-weight: 600; text-align: center; padding: 15px 10px; border-right: 1px solid #34495e; position: relative; }
        th:last-child { border-right: none; }
        .month-header { display: flex; flex-direction: column; align-items: center; }
        .month-name { font-size: 1em; margin-bottom: 5px; }
        .feeding-days { font-size: 0.85em; background-color: #3498db; padding: 3px 8px; border-radius: 12px; margin-top: 5px; font-weight: 500; color: #fff; }
        td { padding: 14px 10px; text-align: center; border-bottom: 1px solid #e1e5eb; border-right: 1px solid #e1e5eb; }
        td:last-child { border-right: none; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        tr:hover { background-color: #f1f7fd; }
        .sl-column { font-weight: bold; color: #2c3e50; width: 60px; }
        .name-column { text-align: left; font-weight: 500; width: 180px; }
        .quantity-column, .rate-column { font-weight: 500; width: 120px; }
        .month-column { width: 100px; }
        .annual-column, .total-column { font-weight: 600; width: 140px; }
        .grand-total-row { background-color: #2c3e50 !important; color: white; font-weight: 600; font-size: 1.1em; }
        .grand-total-row td { border-top: 3px solid #3498db; border-bottom: none; }
        .footer-note { font-size: 0.9em; color: #7f8c8d; text-align: center; margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; }
        .currency { color: #27ae60; font-weight: 600; }
        /* toolbar */
        .report-toolbar { display:flex; justify-content: flex-end; gap: 10px; margin-bottom: 18px; align-items: center; }
        .btn-export { padding: 10px 14px; border-radius: 6px; background:#2980b9; color:white; border: none; font-weight:600; text-decoration:none; display:inline-block; }
        .btn-export:hover { background:#1f6f9a; }
        @media (max-width: 768px) {
            .container { padding: 15px; }
            h1 { font-size: 1.5em; }
            th, td { padding: 10px 6px; font-size: 0.9em; }
            .feeding-days { font-size: 0.75em; padding: 2px 5px; }
            .report-toolbar { justify-content: center; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Monthly Feed Requirement & Cost Analysis</h1>
    <p class="subtitle">Annual feed requirements with monthly breakdown and cost calculations</p>

    {# --- Toolbar with Export to PDF button --- #}
    <div class="report-toolbar" role="toolbar" aria-label="Report actions">
        {# Build parameters from current data / request to preserve user's selections #}
        {% set fastingParam = app.request.query.get('fastingDay') is not null ? app.request.query.get('fastingDay') : (data.fastingDay is defined ? data.fastingDay : -1) %}
        {% set categoryParam = app.request.query.get('category') is not null ? app.request.query.get('category') : (data.category is defined and data.category.id is defined ? data.category.id : (data.category is defined ? data.category : 0)) %}

        <a class="btn-export"
           href="{{ path('export_yearly_feed', {'year': data.year, 'fastingDay': fastingParam, 'category': categoryParam}) }}"
           target="_blank"
           rel="noopener">
            Export as PDF
        </a>
    </div>

    <div class="table-container">
        <table>
            <thead>
            <tr>
                <th class="sl-column">SL No.</th>
                <th class="name-column">Name of Feed</th>
                <th class="quantity-column">Quantity per Day (kg)</th>

                {# month headers dynamic with effective days #}
                {% for m in 1..12 %}
                    <th class="month-column">
                        <div class="month-header">
                            <span class="month-name">{{ data.months_info[m].month_name }}</span>
                            <span class="feeding-days">{{ data.months_info[m].effective_days }} days</span>
                        </div>
                    </th>
                {% endfor %}

                <th class="annual-column">Annual Requirement (kg)</th>
                <th class="rate-column">Rate per kg (₹)</th>
                <th class="total-column">Total Amount per Year (₹)</th>
            </tr>
            </thead>
            <tbody>
            {% set idx = 0 %}
            {% for row in data.feed_items_table %}
                {% set idx = idx + 1 %}
                <tr>
                    <td class="sl-column">{{ idx }}</td>
                    <td class="name-column">{{ row.name }}</td>
                    <td class="quantity-column">
                        {{ row.quantity_per_day is defined ? row.quantity_per_day|number_format(2, '.', ',') : '0.00' }}
                    </td>

                    {# monthly totals — show with 1 decimal like your example #}
                    {% for m in 1..12 %}
                        <td>{{ row.monthly_totals[m]|default(0)|number_format(1, '.', ',') }}</td>
                    {% endfor %}

                    <td class="annual-column">{{ row.year_total|number_format(0, '.', ',') }}</td>

                    <td class="rate-column">
                        {% if row.rate_per_kg is defined and row.rate_per_kg > 0 %}
                            {{ row.rate_per_kg|number_format(0, '.', ',') }}
                        {% else %}
                            -
                        {% endif %}
                    </td>

                    <td class="total-column currency">
                        {% if row.annual_cost is defined and row.annual_cost > 0 %}
                            ₹{{ row.annual_cost|number_format(0, '.', ',') }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
            {% else %}
                <tr><td colspan="18">No feed items found for this category.</td></tr>
            {% endfor %}

            {# Grand Total Row #}
            <tr class="grand-total-row">
                <td colspan="3">GRAND TOTAL</td>

                {# monthly grand totals — 1 decimal like examples #}
                {% for m in 1..12 %}
                    <td>{{ data.monthly_grand_totals[m]|default(0)|number_format(1, '.', ',') }}</td>
                {% endfor %}

                <td>{{ data.monthly_grand_totals.year_total|default(0)|number_format(0, '.', ',') }} kg</td>
                <td>-</td>
                <td class="currency">
                    {# server-supplied total_annual_cost preferred; fallback to summing rows #}
                    {% if data.total_annual_cost is defined %}
                        ₹{{ data.total_annual_cost|number_format(0, '.', ',') }}
                    {% else %}
                        {% set grandMoney = 0 %}
                        {% for row in data.feed_items_table %}
                            {% set grandMoney = grandMoney + (row.annual_cost|default(0)) %}
                        {% endfor %}
                        ₹{{ grandMoney|number_format(0, '.', ',') }}
                    {% endif %}
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="footer-note">
        <p><strong>Note:</strong> Monthly quantities are calculated as (Quantity per Day × Feeding Days per Month). Annual total is the sum of all monthly quantities.</p>
        <p>Total amount per year = Annual Requirement (kg) × Rate per kg (₹)</p>
    </div>
</div>
</body>
</html>
